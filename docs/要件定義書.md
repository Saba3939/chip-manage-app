# チップ管理アプリ 要件定義書

## 1. プロジェクト概要

### 1.1 目的
リアルで行うポーカーゲームや、トランプゲームにおいて、チップの管理をデジタル化し、スムーズなゲーム進行と正確な清算を実現する。
またチップは引き継ぎでチップを貯めていくことを楽しみにトランプゲームをより楽しくプレイできるようにすることが目的である。

### 1.2 スコープ
- **対象**: チップの送受信管理、残高管理、清算機能
- **対象外**: ポーカーのゲームロジック、役判定、ディーラー機能

---

## 2. ユーザーストーリー

### 2.1 基本フロー
1. ホストがゲームセッションを作成
2. 参加者がQRコードをスキャンしてセッションに参加
3. 全員が参加したらゲーム開始
4. ゲーム中、勝者が敗者からチップを受け取る操作を行う
5. ゲーム終了時、清算額を確認して現金精算

---

## 3. 機能要件

### 3.1 ユーザー管理
- **ユーザー登録・ログイン**
  - 実装方法: Supabase Authを使用
  - 必要情報: メールアドレス、パスワード、表示名
  - ソーシャルログイン対応(Google推奨)

### 3.2 セッション管理

#### 3.2.1 セッション作成(ホスト機能)
- **入力項目**
  - セッション名(任意)
  - 初期チップ数(デフォルト: 1000)
  - 最大参加人数(デフォルト: 10人)
  
- **実装方法**
  - Supabaseのsessionsテーブルにレコード作成
  - セッションIDを生成(UUID)
  - QRコード生成: セッションIDを含むURL(`/join/{sessionId}`)
  - ホストは自動的に参加者として登録

#### 3.2.2 セッション参加
- **参加方法**
  - QRコードスキャン → 自動参加
  - セッションID手動入力 → 参加
  
- **実装方法**
  - カメラアクセス: `html5-qrcode`ライブラリ
  - QRコード読み取り後、セッションIDを抽出
  - session_participantsテーブルに参加者追加
  - Supabase Realtimeで参加者リストを自動更新

#### 3.2.3 セッション開始
- **条件**
  - 2人以上の参加者が必要
  - ホストのみ開始可能
  
- **実装方法**
  - セッションステータスを"waiting" → "active"に更新
  - 各参加者に初期チップを付与(balancesテーブル)

### 3.3 チップ送受信機能

#### 3.3.1 送信操作
- **UI**
  - 参加者リスト表示(名前、現在のチップ数)
  - 各参加者に[送る]ボタン配置
  
- **送信フロー**
  1. 受取人を選択
  2. 送信額を入力
  3. 残高チェック(送信者の残高 >= 送信額)
  4. 確認モーダル表示
  5. 送信実行

- **実装方法**
  - Supabase RPC functionで送受信処理(トランザクション)
  - 送信者の残高を減算、受取人の残高を加算
  - transactionsテーブルに履歴記録
  - Realtime機能で全参加者の画面を即時更新

#### 3.3.2 リアルタイム更新
- **実装方法**
  - Supabase Realtime Subscriptionを使用
  - balancesテーブルの変更を購読
  - 変更があれば自動的にUI更新

### 3.4 残高表示
- **表示項目**
  - 自分の現在チップ数(大きく表示)
  - 全参加者のチップ数(リスト形式)
  - チップ総数(検証用)
  
- **実装方法**
  - balancesテーブルからリアルタイム取得
  - 合計チップ数 = 初期チップ × 参加者数(検証)

### 3.5 清算機能

#### 3.5.1 セッション終了
- **条件**
  - ホストのみ終了可能
  
- **清算画面**
```
  参加者 | 初期 | 最終 | 増減   | 清算額
  けんと  | 1000 | 1250 | +250  | +2,500円
  田中    | 1000 | 800  | -200  | -2,000円
  佐藤    | 1000 | 1450 | +450  | +4,500円
  鈴木    | 1000 | 900  | -100  | -1,000円
  山田    | 1000 | 1600 | +600  | +6,000円
```
  ※レート: 1チップ = 10円と仮定

- **実装方法**
  - セッションステータスを"active" → "completed"に更新
  - 各参加者の増減を計算: 最終残高 - 初期チップ
  - レート設定(セッション作成時または終了時に設定)
  - 清算額 = 増減 × レート

#### 3.5.2 履歴保存
- **保存項目**
  - セッション情報(日時、参加者、初期チップ)
  - 各参加者の最終残高と増減
  - 全トランザクション履歴

---

## 4. 非機能要件

### 4.1 パフォーマンス
- リアルタイム更新の遅延: 1秒以内
- QRコード読み取り速度: 2秒以内

### 4.2 セキュリティ
- 認証されたユーザーのみアクセス可能
- セッションへの参加は招待制(QR/ID経由のみ)
- 送受信処理はサーバーサイドで検証

### 4.3 ユーザビリティ
- モバイルファースト設計
- オフライン時のエラーハンドリング
- 誤操作防止の確認ダイアログ

---

## 5. 技術スタック

### 5.1 フロントエンド
- **フレームワーク**: Next.js 14+ (App Router)
- **言語**: TypeScript
- **UIライブラリ**: 
  - Tailwind CSS(スタイリング)
  - shadcn/ui(UIコンポーネント)
- **QR機能**:
  - 生成: `qrcode.react`
  - 読み取り: `html5-qrcode`

### 5.2 バックエンド
- **BaaS**: Supabase
  - Authentication(認証)
  - PostgreSQL Database(データ保存)
  - Realtime Subscriptions(リアルタイム更新)
  - RPC Functions(送受信トランザクション)

### 5.3 デプロイ
- **ホスティング**: Vercel
- **ドメイン**: 未定

---

## 6. データベース設計(概要)

### 6.1 主要テーブル

#### users(Supabase Auth管理)
- id, email, display_name

#### sessions
- id, host_user_id, name, initial_chips, max_participants, rate, status, created_at

#### session_participants
- id, session_id, user_id, joined_at

#### balances
- id, session_id, user_id, amount, updated_at

#### transactions
- id, session_id, from_user_id, to_user_id, amount, created_at

### 6.2 実装方法
- Supabase Migration機能でテーブル作成
- Row Level Security(RLS)でアクセス制御
- Foreign Keyで整合性保証

---

## 7. 開発フェーズ

### Phase 1: MVP(基本機能)
- ユーザー登録・ログイン
- セッション作成・参加(QR対応)
- チップ送受信
- 残高表示(リアルタイム)

### Phase 2: 清算機能
- セッション終了
- 清算額計算・表示
- 履歴保存

### Phase 3: 改善
- 履歴閲覧機能
- 統計情報(勝率など)
- UIの改善

---

## 8. 懸念事項・今後の検討

### 8.1 懸念事項
- **ネットワーク不安定時の対応**: オフライン時の操作をどう扱うか
- **誤送信の取り消し**: 送信後のキャンセル機能は必要か
- **参加者の途中退出**: 残高の扱いをどうするか

### 8.2 将来的な拡張
- グループ機能(定期的に遊ぶメンバー管理)
- ゲーム履歴の統計・分析
- トーナメント形式のサポート
- 他のカードゲーム(ブラックジャック等)への対応

---

## 9. 成功指標
- スムーズなゲーム進行(操作時間の短縮)
- 清算ミスゼロ
- ユーザーの継続利用率
